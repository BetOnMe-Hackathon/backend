<?php

namespace App\Http\Controllers;

use App\Jobs\ProcessOfferFromInsurer;
use Illuminate\Http\Request;

class WebHookController extends Controller
{

    public function receive(Request $request)
    {
        \Log::info('x', $request->input());

        // $input = json_decode('{"FromName":"Martins Sipenko","From":"martins.sipenko@gmail.com","FromFull":{"Email":"martins.sipenko@gmail.com","Name":"Martins Sipenko","MailboxHash":""},"To":"r65961n8gyvr2xex8dz0okqml473jp8x@bidonme.eu","ToFull":[{"Email":"r65961n8gyvr2xex8dz0okqml473jp8x@bidonme.eu","Name":"","MailboxHash":""}],"Cc":"","CcFull":[],"Bcc":"","BccFull":[],"OriginalRecipient":"r65961n8gyvr2xex8dz0okqml473jp8x@bidonme.eu","Subject":"Re: Insurance quote request!","MessageID":"6ae30acd-d6de-4354-9adb-577b3f992f9f","ReplyTo":"","MailboxHash":"","Date":"Sat, 12 Nov 2016 11:50:57 -0800","TextBody":"79.89\r\n\r\n\r\nOn November 12, 2016 at 21:48:15,\r\nr65961n8gyvr2xex8dz0okqml473jp8x@bidonme.eu (\r\nr65961n8gyvr2xex8dz0okqml473jp8x@bidonme.eu) wrote:\r\n\r\nTransaction: o97g62p08z5kj1em9dxlm43yroqv9n50\r\nRound: 2\r\n","HtmlBody":"<html><head><style>body{font-family:Helvetica,Arial;font-size:13px}</style></head><body style=\"word-wrap:break-word\"><div id=\"bloop_customfont\" style=\"font-family:Helvetica,Arial;font-size:13px;color:rgba(0,0,0,1.0);margin:0px;line-height:auto\">79.89</div> <br> <div id=\"bloop_sign_1478980241357451008\" class=\"bloop_sign\"></div> <br><p class=\"airmail_on\">On November 12, 2016 at 21:48:15, <a href=\"mailto:r65961n8gyvr2xex8dz0okqml473jp8x@bidonme.eu\">r65961n8gyvr2xex8dz0okqml473jp8x@bidonme.eu</a> (<a href=\"mailto:r65961n8gyvr2xex8dz0okqml473jp8x@bidonme.eu\">r65961n8gyvr2xex8dz0okqml473jp8x@bidonme.eu</a>) wrote:</p> <blockquote type=\"cite\" class=\"clean_bq\"><span><div><div></div><div>\r\n\r\n\r\n<title></title>\r\n\r\n\r\nTransaction: o97g62p08z5kj1em9dxlm43yroqv9n50<br>\r\nRound: 2<img src=\"http://ea.pstmrk.it/open/djFfMjAxNjExMTJfMTI1ODU4XzI0NzQxODFfXzBmNWU5NmVkLTRkZjctNDNkNy1iMTljLTVjODBmYmUxZjdkYl9tYXJ0aW5zLnNpcGVua28raW5zdXJlcjFAZ21haWwuY29t\" width=\"1\" height=\"1\" border=\"0\" alt=\"\">\r\n\r\n\r\n</div></div></span></blockquote></body></html>\r\n","StrippedTextReply":"79.89\r\n\r\n\r\nOn November 12, 2016 at 21:48:15,\r\nr65961n8gyvr2xex8dz0okqml473jp8x@bidonme.eu (\r\nr65961n8gyvr2xex8dz0okqml473jp8x@bid","Tag":"","Headers":[{"Name":"Received","Value":"by inbound.postmarkapp.com (Postfix, from userid 993)id 268E2360AC3; Sat, 12 Nov 2016 19:51:01 +0000 (UTC)"},{"Name":"X-Spam-Checker-Version","Value":"SpamAssassin 3.4.0 (2014-02-07) onp-pm-inbound01-pktsjc1"},{"Name":"X-Spam-Status","Value":"No"},{"Name":"X-Spam-Score","Value":"1.5"},{"Name":"X-Spam-Tests","Value":"DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,FREEMAIL_FROM,HTML_IMAGE_ONLY_12,HTML_MESSAGE,SPF_PASS,T_REMOTE_IMAGE,UNPARSEABLE_RELAY"},{"Name":"Received-SPF","Value":"Pass (sender SPF authorized) identity=mailfrom; client-ip=74.125.82.46; helo=mail-wm0-f46.google.com; envelope-from=martins.sipenko@gmail.com; receiver=r65961n8gyvr2xex8dz0okqml473jp8x@bidonme.eu"},{"Name":"Received","Value":"from mail-wm0-f46.google.com (mail-wm0-f46.google.com [74.125.82.46])(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))(No client certificate requested)by inbound.postmarkapp.com (Postfix) with ESMTPS id 8F79C360AAEfor <r65961n8gyvr2xex8dz0okqml473jp8x@bidonme.eu>; Sat, 12 Nov 2016 14:50:59 -0500 (EST)"},{"Name":"Received","Value":"by mail-wm0-f46.google.com with SMTP id a197so34223989wmd.0        for <r65961n8gyvr2xex8dz0okqml473jp8x@bidonme.eu>; Sat, 12 Nov 2016 11:50:59 -0800 (PST)"},{"Name":"DKIM-Signature","Value":"v=1; a=rsa-sha256; c=relaxed/relaxed;        d=gmail.com; s=20120113;        h=from:in-reply-to:references:mime-version:date:message-id:subject:to;        bh=c1QT9JHqqmBbGycbOL5yFYYo6YDO5uR80eCcNcHXjKY=;        b=Nc+fIbWDJighViooYggwomlvbZoNvLoOpylVBdPBLsZR8AzXV/DfvkG1/Lo/aAnxrW         Gv7T6V+XNjNhvq3S1pgJfyhDotXl3Nq0jqK9m7oHGCGjvGzGkzHuuw9SDdyu/Y1/KM9D         tZIL62HPka2+LCQ5HNVmSHY3RSnMTr3GNQb16FFKDKv8yMVNK/UoE4ipRwL3sOs52yhK         EEoozZl1KLXCbUBcoQ2hKV5ehnC7v+0iK6UUqUsW8DFGklmr3bYpsa6aASWe/0Wv+mcC         0IK1/I2lnWIU1D45PeyKjo+AILvEpDZ2R8MiLsrdKCRi6+EbNmXIoUZDv/bGn2GMReaI         y6xQ=="},{"Name":"X-Google-DKIM-Signature","Value":"v=1; a=rsa-sha256; c=relaxed/relaxed;        d=1e100.net; s=20130820;        h=x-gm-message-state:from:in-reply-to:references:mime-version:date         :message-id:subject:to;        bh=c1QT9JHqqmBbGycbOL5yFYYo6YDO5uR80eCcNcHXjKY=;        b=TKcaLfPCm60f1ba0mJkzuodF8QhzDvfvHu+P24n8E46fb3hWOCackXhu/gUIP8RmwM         jEvvXQFshMNVuqJKZvIUrkRpxnh6PxR7TxUDNB1lyH8jXztFaTo+VTa2rHcvJLdKMFIt         QiQ3pKIGMDjL/K/ReML7D1P5Ff06JqrC7DdGqZTtbCtRB33pNjM6kT1VZJiLAQGM1NK1         Uq0E32LiBg9M9uepizTmxciTRz8BjuPvPqgO6vPOWeiK6q/t64ZGCpIkR6nQjfY8A2Nj         ZkZ3Gf2Fifi12okY7RmMc1msgGI6Jab+waNBTNPREGaFEj7HoDMstIK5sU2dqQXZ/0D1         QmOg=="},{"Name":"X-Gm-Message-State","Value":"ABUngvffij3ThrBCd8S1EbWgBhaRtmxUJp0XMq6SyfTaFwa6R20FfW6bNQlz8/JDaSguxNf2jzac4uENHn2Umg=="},{"Name":"X-Received","Value":"by 10.28.174.194 with SMTP id x185mr3519080wme.4.1478980257827; Sat, 12 Nov 2016 11:50:57 -0800 (PST)"},{"Name":"Received","Value":"from 1058052472880 named unknown by gmailapi.google.com with HTTPREST; Sat, 12 Nov 2016 11:50:57 -0800"},{"Name":"In-Reply-To","Value":"<0f5e96ed-4df7-43d7-b19c-5c80fbe1f7db@mtasv.net>"},{"Name":"References","Value":"<0f5e96ed-4df7-43d7-b19c-5c80fbe1f7db@mtasv.net>"},{"Name":"X-Mailer","Value":"Airmail (390)"},{"Name":"MIME-Version","Value":"1.0"},{"Name":"Message-ID","Value":"<CA+4wLCDYAdBdEhvaUV+nyAn6PTG6S-3Akp+7Gzk-JjL1_7zBKA@mail.gmail.com>"}],"Attachments":[]} ', true);

        dispatch(new ProcessOfferFromInsurer($request->input()));

        return 'ok';
    }
}
